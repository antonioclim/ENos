@startuml
!theme plain
skinparam backgroundColor #FEFEFE
skinparam defaultFontName DejaVu Sans
skinparam defaultFontSize 10

title Capabilities Model vs. Traditional SUID
caption Course 13: Security in Operating Systems — Principle of Least Privilege

left to right direction

package "**Traditional Model (SUID root)**" as TRAD #MistyRose {
  actor "Normal user\n(uid=1000)" as U1
  
  rectangle "ping\n-rwsr-xr-x\nowner: root" as PING1 #LightCoral
  
  rectangle "**All root privileges**\n• CAP_NET_RAW\n• CAP_SYS_ADMIN\n• CAP_DAC_OVERRIDE\n• CAP_KILL\n• ... (38+ capabilities)" as ROOT1 #Red
  
  U1 -right-> PING1 : "execute"
  PING1 -right-> ROOT1 : "EUID=0\n**DANGER!**"
  
  note bottom of ROOT1
    **Problem:**
    If ping has a vulnerability
    → attacker gains **full root**
  end note
}

package "**Capabilities Model (modern)**" as CAP #Honeydew {
  actor "Normal user\n(uid=1000)" as U2
  
  rectangle "ping\n-rwxr-xr-x\n+cap_net_raw" as PING2 #LightGreen
  
  rectangle "**Only CAP_NET_RAW**\n(raw sockets for ICMP)" as ROOT2 #Green
  
  U2 -right-> PING2 : "execute"
  PING2 -right-> ROOT2 : "**MINIMUM**\nprivilege"
  
  note bottom of ROOT2
    **Advantage:**
    If ping has a vulnerability
    → attacker gains **only** net_raw
    → CANNOT read /etc/shadow
    → CANNOT install rootkit
  end note
}

note right of CAP
  **Common Linux Capabilities:**
  
  | Capability | Permits |
  |------------|---------|
  | CAP_NET_RAW | raw sockets |
  | CAP_NET_BIND_SERVICE | bind port <1024 |
  | CAP_SYS_PTRACE | strace/gdb |
  | CAP_DAC_READ_SEARCH | bypass read perms |
  | CAP_SETUID | change UID |
  | CAP_SYS_ADMIN | catch-all admin |
  
  **Set capability:**
  sudo setcap cap_net_raw+ep /usr/bin/ping
  
  **Verify:**
  getcap /usr/bin/ping
end note

rectangle "**Privilege Hierarchy**" as HIER #LightBlue {
  rectangle "root (UID 0)\nAll capabilities" as R #Red
  rectangle "Specific capabilities\n(granular)" as C #Yellow
  rectangle "Normal user\n(no extra privileges)" as N #Green
  
  R -down-> C : "Principle of\nleast\nprivilege"
  C -down-> N
}

@enduml
